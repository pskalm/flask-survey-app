{% extends "base.html" %}
{% block content %}
<div class="container py-5">

  <!-- Upload & Download CSV -->
  <div class="d-flex justify-content-end gap-2 mb-4">
    <a href="/upload" class="btn btn-success">üì§ Upload CSV</a>
    <a href="/download" class="btn btn-success">üì• Download CSV</a>
  </div>

  <!-- Word Cloud -->
  <h2 class="mt-5">‚òÅÔ∏è Word Cloud from Likes & Suggestions</h2>
  <div class="wordcloud-wrapper">
    <div class="wordcloud-box shadow rounded p-2">
      <img src="{{ url_for('static', filename='wordcloud.png') }}" alt="WordCloud" class="img-fluid">
    </div>
  </div>

  <!-- Word Cloud Style -->
  <style>
    .wordcloud-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 10px;
    }

    .wordcloud-box {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      max-width: 500px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .wordcloud-box img {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
    }
  </style>

  <!-- Bar Chart (Department Ratings) -->
  <h2 class="mt-5">üìä Department Ratings</h2>
  <div class="text-center">
    <canvas id="barChart" class="mx-auto custom-bar-chart"></canvas>
  </div>
  <style>
    .custom-bar-chart {
      width: 50% !important;
      height: 300px !important;
    }
  </style>

  <!-- Pie Chart (Gender) -->
  <h2 class="mt-5">üë• Gender Distribution</h2>
  <div class="d-flex justify-content-center">
    <canvas id="genderChart" class="small-pie-chart"></canvas>
  </div>
  <style>
    .small-pie-chart {
      width: 300px !important;
      height: 300px !important;
    }
  </style>

  <!-- Line Chart (Individual Ratings) -->
  <h2 class="mt-5">üßç Individual Ratings</h2>
  <div class="text-center">
    <canvas id="lineChart" class="mx-auto custom-line-chart"></canvas>
  </div>
  <style>
    .custom-line-chart {
      width: 50% !important;
      height: 300px !important;
    }
  </style>

  <!-- Summary Stats -->
  <p class="mt-4"><strong>Total Responses:</strong> {{ total_responses }}</p>
  <p><strong>Average Age:</strong> {{ average_age }}</p>
  <p><strong>Unique Names:</strong> {{ unique_names | length }}</p>

  <!-- Response Table -->
  <h4 class="mt-5">üìù Response Table</h4>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead class="table-dark">
        <tr>
          <th>Name</th><th>Email</th><th>Age</th><th>Gender</th><th>Department</th>
          <th>Rating</th><th>Likes</th><th>Suggestions</th><th>Recommend</th>
        </tr>
      </thead>
      <tbody>
        {% for r in responses %}
        <tr>
          <td>{{ r.name }}</td>
          <td>{{ r.email }}</td>
          <td>{{ r.age }}</td>
          <td>{{ r.gender }}</td>
          <td>{{ r.dept }}</td>
          <td>{{ r.rating }}</td>
          <td>{{ r.likes }}</td>
          <td>{{ r.suggestions }}</td>
          <td>{{ r.recommend }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartData = {
    dept_labels: {{ chart_data.dept_labels | tojson }},
    dept_ratings: {{ chart_data.dept_ratings | tojson }},
    gender_labels: {{ chart_data.gender_labels | tojson }},
    gender_counts: {{ chart_data.gender_counts | tojson }},
    line_labels: {{ chart_data.line_labels | tojson }},
    line_ratings: {{ chart_data.line_ratings | tojson }}
  };

  new Chart(document.getElementById("barChart"), {
    type: 'bar',
    data: {
      labels: chartData.dept_labels,
      datasets: [{
        label: "Average Rating by Department",
        data: chartData.dept_ratings,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 5
        }
      }
    }
  });

  new Chart(document.getElementById("genderChart"), {
    type: 'pie',
    data: {
      labels: chartData.gender_labels,
      datasets: [{
        label: "Gender Distribution",
        data: chartData.gender_counts,
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
      }]
    },
    options: { responsive: true }
  });

  new Chart(document.getElementById("lineChart"), {
    type: 'line',
    data: {
      labels: chartData.line_labels,
      datasets: [{
        label: "Rating per Person",
        data: chartData.line_ratings,
        borderColor: "rgba(255,99,132,1)",
        fill: false,
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });
</script>
{% endblock %}
